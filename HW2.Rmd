---
title: 'HW2: Построение предсказания относительно успешности проекта'
author: 'Иванов Павел, paivanov_2'
output: html_document
---

### Задача:
1) Провести разведочный анализ данных и выявить гипотезы относительно успешности проекта
2) Проверить гипотезы с помощью статистических тестов
3) Построить дерево решений, которое демонстрировало бы, при каких условиях проект с большей вероятностью будет успешным

## Разведочный анализ

```{r echo=FALSE, message=FALSE, warning=FALSE}
#загружаем необходимые библиотеки и датасеты
library(readr)
kickstarter = read_csv("~/shared/minor2_2020/1-Intro/hw2/kickstarter.csv")
USD = read_csv("~/shared/minor2_2020/1-Intro/hw2/usd_goals.csv")
library(rpart)
library(rpart.plot)
library(dplyr)
library(ggplot2)
library(lubridate)
library (coin)
library(party)
```
 
Одной из самых важных характеристик проекта является категория, к которой он принадлежит. Данные содержат информацию как об основной категории (main_category), так и о более узконаправленной категории проекта (category). Для удобства следует обратиться к первому варианту, так как во втором случае содержится множество уникальных значений, среди которых было бы проблематично выявить определенные закономерности. Попробуем на гистограмме посмотреть, отличается ли соотношение успешных и неуспешных проектов среди различных основных категорий.


```{r echo=FALSE, message=FALSE, warning=FALSE}
#Преобразуем нужные нам колонки с информацией об основной категории и состоянии проекта из класса character в factor, чтобы с ними можно было бы работать в процессе построения графика
kickstarter$main_category=as.factor(kickstarter$main_category)
kickstarter$state=as.factor(kickstarter$state)
#Строим график
ggplot(data=kickstarter)+
  geom_histogram(aes(x=main_category, fill=state), stat="count", alpha=0.5)+
  coord_flip()+
  ggtitle("Успешность разных основных категорий")+
  xlab("Основная категория\n")+
  ylab("\nКоличество проектов")+
  scale_fill_discrete("Состояние проекта\n",
                      labels=c("Провал", "Успех"))
  
```

Несмотря на разное количество проектов в категориях, в каждой из них наблюдается отличающиеся соотношения успешных и неуспешных проектов. Наличие зависимости успешности проекта от его категории и будет нашей первой гипотезой.

Следующим показателем, который мог бы влиять на успешность проекта является цель, т.е. сумма, которую необходимо проекту набрать. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
#Добавляем к имеющемуся датасету колонку, содержащую информацию о планируемой сумме в валюте USD
kickstarter=kickstarter%>%left_join(USD, by="id")%>%select(-goal.y)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#считаем среднюю планируемую сумму среди успешных и среди неуспешных проектов
GOAL=kickstarter%>%group_by(state)%>%summarise(meang=mean(usd_goal_real))
#строим график
ggplot(data=GOAL)+
geom_bar(aes(x=state, y=meang), stat="identity")+ 
  geom_bar(data=GOAL%>%filter(state=="failed"), aes(x=state, y=meang), stat="identity", fill="#EF6D8E")+
  geom_bar(data=GOAL%>%filter(state=="successful"), aes(x=state, y=meang), stat="identity", fill="#71A5D5")+
  ggtitle("Планируемая сумма среди успешных и неуспешных проектов")+
  xlab("\nСостояние проекта")+
  ylab("Средняя планируемая сумма\n")+
  scale_x_discrete(labels = c("Неуспешные","Успешные"))
```

Как показывает столбчатая диаграмма, на основе наших данных можно пронаблюдать, что среди успешных проектов средняя планируемая сумма гораздо меньше, нежели в неуспешных. Следовательно, зависимость успешности от цели можно принять как вторую гипотезу для проверки.

Последним показателем, на который можно было бы обратить внимание, является срок, дающийся на сбор средств. Так как данные содержат информацию о дате запуска проекта и его дедлайне, можно посчитать, какое количество дней даётся на сбор средств, а затем узнать, какой средний показатель среди успешных и неуспешных проектов.

```{r echo=FALSE, message=FALSE, warning=FALSE}
#вычисляем разницу между датами дэдлайна и запуска проекта, т.е. срок, данный на сбор средств, а затем находим средние значения этого срока у успешных и неуспешных проектов
kickstarter$launched=as.Date(kickstarter$launched)
kickstarter=kickstarter%>%mutate(term=deadline-launched)
TERM=kickstarter%>%group_by(state)%>%summarize(mean_term=mean(term))
#строим график
ggplot(data=TERM)+
  geom_bar(aes(x=state, y=mean_term), stat="identity")+
  geom_bar(data=TERM%>%filter(state=="failed"), aes(x=state, y=mean_term), stat="identity", fill="#EF6D8E")+
  geom_bar(data=TERM%>%filter(state=="successful"), aes(x=state, y=mean_term), stat="identity", fill="#71A5D5")+
  ggtitle("Cрок сбора средств среди успешных и неуспешных проектов")+
  xlab("\nСостояние проекта")+
  ylab("Средний срок\n")+
  scale_x_discrete(labels = c("Неуспешные","Успешные"))
```

В данном случае, столбчатая диаграмма показала, что конкретно в наших данных разница в сроке среди успешных и неуспешных проектов имеется. Таким образом, существование связи этих переменных - успеха и срока, данного на сбор средств, - будет нашей третьей гипотезой. 


## Проверка гипотез



**ГИПОТЕЗА №1. Успешность проекта зависит от основной категории** 

**НУЛЕВАЯ ГИПОТЕЗА. Зависимости между основной категорией и успешностью проекта не существует**

Чтобы подтвердить, что различие успеха в разных категориях действительно существует и оно не случайно, можно прибегнуть к статистическим тестам. В частности, используем универсальный метод перестановок (вычисление p-value) и критерий хи-квадрат, позволяющий оценить взаимосвязь между категориальными переменными (в нашем случае категория и состояние проекта)

```{r echo=FALSE, message=FALSE, warning=FALSE}
independence_test(main_category ~ state, data=kickstarter)
ch <- chisq.test(kickstarter$main_category, kickstarter$state)
ch
```

Нулевая гипотеза отвергается, так как согласно и методу перестановок, и хи-квадрату, значение p-value < 2.2e-16 (слишком мало)
Следовательно, мы можем принять альтернативную гипотезу - взаимосвязь категории и успешности проекта существует, иными словами, разница между разными категориями относительно того, будут они успешны или нет,
*статистически значима*


**ГИПОТЕЗА №2. Успешность проекта зависит от суммы, которую создатель проекта планирует собрать** 

**НУЛЕВАЯ ГИПОТЕЗА. Зависимости между успешностью проекта и планируемой суммой не существует**

В этот раз мы сравниваем не две категориальных переменных, так как одна из них - goal, - числовая. Для проверки гипотезы мы так же применяем метод перестановок, а вместо хи-квадрата используем t-критерий Стьюдента (t-test): 

```{r echo=FALSE, message=FALSE, warning=FALSE}
independence_test(goal.x ~ state, data=kickstarter)
t.test(goal.x ~ state, data = kickstarter)
```
И в случае теста перестановок, и в случае t-критерия Стьюдента наличие статистически значимой разницы подтвердилось (показатель p-value достаточно мал, по результатам представленных статистических тестов он равен 9.897e-08 и 5.888e-10 соответственно).
Таким образом, мы можем снова отвергнуть нулевую гипотезу и в свою очередь принять альтернативную, которая предполагает, что разница относитело успешности между проектам с разными планируемыми суммами действительно есть и она *статистически значима*.



**ГИПОТЕЗА №3.Успешность проекта зависит от срока, за который планируется набрать сумму** 

**НУЛЕВАЯ ГИПОТЕЗА. Зависимости между успешностью проекта и запланированным сроком не существует** 

Последняя гипотеза так же содержит числовую переменную - время, предоставленное на сбор средств. Соответственно, эта гипотеза может быть проверена аналогично второй, т.е. с иcпользованием тех же статистических тестов - метода перестановок и t-критерия Стьюдента:

```{r echo=FALSE, message=FALSE, warning=FALSE}
kickstarter$term=as.integer(kickstarter$term)
t.test(term ~ state, data = kickstarter)
independence_test(term ~ state, data=kickstarter)
```
И в случае теста перестановок, и в случае t-критерия Стьюдента наличие статистически значимой разницы снова подтвердилось (в обоих случаях p-value < 2.2e-16).
Нулевая гипотеза отвергается, и мы принимаем альтернативную - зависимость успеха от срока, данного на сбор средств, есть.



## Построение дерева решений

Для того, чтобы определить условия, увеличивающие вероятность успешности проекта, можно построить дерево решений. Более того, с целью избежать переобучения, мы разделяем данные на тренировочную и тестовую выборки (тренировочная - 80%, тестовая - оставшиеся 20%). Дерево строиться на тренировочной выборке, затем точность его предсказания сравнивается с точностью, высчитанной на основе тестовой выборки.


```{r echo=FALSE, message=FALSE, warning=FALSE}
set.seed(333)
# Возьмем 80% как обучающие
kick_train = kickstarter %>% sample_frac(.8)
# создаем тестовый набор данных через анти-джойн, чтобы убрать все наблюдения, попавшие в обучающую выборку
kick_test = anti_join(kickstarter, kick_train, by = 'id') 
#строим дерево решений на основе тренировочной выборки
tree1 <- rpart(state ~ main_category+usd_goal_real+term, method = "class", data = kick_train)
prp(tree1, extra=8, digits=-1, box.palette = "auto", cex=0.85)
# проверяем точность предсказания дерева на тренировочной выборке
pred = predict(tree1, type="class", data = credits_train)
t=table(pred, kick_train$state)
knitr::kable(t)
(t[1,1] + t[2,2])/sum(t)
# проверяем точность предсказания дерева на тестовой выборке
pred_test = predict(tree1, type="class", newdata =kick_test)
t=table(pred_test, kick_test$state)
knitr::kable(t)
(t[1,1] + t[2,2])/sum(t)

```
Точности тренировочной и тестовой выборок близки друг к другу (0.65 и 0.64), что свидетельствует о генерализуемости данной модели. 
Что касается выводов, на основе предсказаний *конкретно* этого дерева решений к потенциально успешным проектам можно отнести те проекты:

* которые не относятся к категориям Crafts, Fashion, Film & Video, Food, Journalism, Photography, Publishing, Technology, чья цель меньше, чем 30312, и срок на сбор средств меньше 30 дней

* которые не относятся к категориям Crafts, Fashion, Film & Video, Food, Journalism, Photography, Publishing, Technology, Art, Design, Games и Music, чья цель меньше, чем 30312, а срок на выполнение больше чем или равен 30 дней, но меньше, чем 56.

* которые относятся к категориям Art, Design, Games и Music, чья цель меньше, чем 30312, а срок на выполнение больше, чем 31 день, но меньше, чем 56.

* которые относятся к категориям Art, Design, Games и Music, чей срок на выполнение меньше, чем 31 день, а планируемая сумма меньше, чем 1999 


### Дэшборд

Полученные выводы обобщены в виде дэшборда со следующими элементами 

**Элемент 1:** 

 - вид: дерево решений

 - обоснование: с помощью дерева можно компактно и наглядно обобщить условия, необходимые для того, чтобы потенциальный проект был с большей вероятностью успешен. 
 
**Элемент 2:** 

 - вид: число 
 
 - обоснование: разные модели могут по-разному предсказывать успех проекта, поэтому в дэшборд также добавлено значение точности конкретно предоставленной модели, выявленное на тренировочной выборке. Благодаря этому, качество модели можно быстро оценить относительно иных моделей, сравнивая значения точности. 
 
 
**Элемент 3:** 

 - вид: таблица 
 
 - обоснование: одной из первых переменных, на которую мы смотрим в контексте оценки возможной успешности проекта, является основная категория, к которой проект относится. Среди всех категорий были найдены те, среди которых наибольшая доля успешных проектов. Чтобы не перегружать дэшборд, в таблице выведены только топ-3 категории и соответствующие им значения успеха проектов (отношение успешных проектов ко всем проектам)
 
 
**Элемент 4:** 

 - вид: число
 
 - обоснование: следующей переменной, влияющей на успех проекта, мы считаем запланированную сумму, или цель. Так как предварительно было доказано, что разница между целями у успешных и неуспешных проектов статистически значима, в дэшборд выведена средняя запланированная сумма среди успешных проектов.
 
 **Элемент 5:**
 
  - вид: число
 
 - обоснование: последней переменной, оказывающей влияние на успешность проекта, является срок, установленныый на сбор средств. Аналогично с целью, в дэшборд выведено среднее количество дней между запуском и дедлайном сбора средств среди успешных проектов.